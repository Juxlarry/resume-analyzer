#!/bin/bash
set -euo pipefail

cd /rails

if [ -z "${DATABASE_URL:-}" ]; then
  echo "DATABASE_URL is not set. Configure Railway Postgres and expose DATABASE_URL to this service."
  exit 1
fi

if [ "${RUN_DB_PREPARE:-true}" = "true" ]; then
  echo "Running db:prepare..."
  bin/rails db:prepare
else
  echo "Skipping db:prepare (RUN_DB_PREPARE=${RUN_DB_PREPARE:-unset})"
fi

if [ "${RUN_DB_SEED:-false}" = "true" ]; then
  echo "Running db:seed..."
  bin/rails db:seed
fi

export PORT="${PORT:-8080}"
echo "Starting Puma on PORT=${PORT}..."
exec bundle exec puma -C config/puma.rb
