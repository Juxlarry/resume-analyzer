<div class="min-h-screen bg-gray-50 py-8">
  <div class="container mx-auto max-w-5xl px-6">
    <div class="mb-6">
      <a
        [routerLink]="['/job-descriptions', jobId]"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Analysis
      </a>
    </div>

    <div *ngIf="isLoading" class="flex justify-center items-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <div *ngIf="errorMessage && !isLoading" class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
      <p class="text-red-700">{{ errorMessage }}</p>
    </div>

    <div *ngIf="!isLoading && jobDescription" class="space-y-6">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Resume Rewrite</h1>
        <p class="text-gray-600">{{ jobDescription.title }}</p>
      </div>

      <div
        *ngIf="jobDescription.resume_analysis?.status !== 'completed'"
        class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg">
        <p class="text-yellow-900 font-semibold">Analysis is not completed yet.</p>
        <p class="text-yellow-700 mt-1">Complete resume analysis first, then start rewrite.</p>
      </div>

      <div *ngIf="jobDescription.resume_analysis?.status === 'completed'" class="space-y-6">
        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Select Improvements to Apply</h2>
          <div *ngIf="availableSuggestions.length === 0" class="text-sm text-gray-500">
            No parsed suggestions found. Add keywords/projects or instructions below.
          </div>
          <div class="space-y-2">
            <label
              *ngFor="let suggestion of availableSuggestions"
              class="flex items-start gap-3 p-3 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
              <input
                type="checkbox"
                class="mt-1"
                [checked]="selectedSuggestions.includes(suggestion)"
                (change)="toggleSuggestion(suggestion)">
              <span class="text-gray-700">{{ suggestion }}</span>
            </label>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Add Keywords</h2>
          <div class="flex gap-2">
            <input
              type="text"
              class="flex-1 border border-gray-300 rounded px-3 py-2"
              placeholder="Enter keyword"
              [(ngModel)]="keywordInput"
              (keyup.enter)="addKeyword(keywordInput)">
            <button
              type="button"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              (click)="addKeyword(keywordInput)">
              Add
            </button>
          </div>

          <div class="mt-4 flex flex-wrap gap-2" *ngIf="additionalKeywords.length > 0">
            <span
              *ngFor="let keyword of additionalKeywords"
              class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
              {{ keyword }}
              <button type="button" class="font-bold" (click)="removeKeyword(keyword)">x</button>
            </span>
          </div>

          <div class="mt-4" *ngIf="(jobDescription.resume_analysis?.missing_keywords?.length || 0) > 0">
            <p class="text-sm text-gray-500 mb-2">Suggested missing keywords:</p>
            <div class="flex flex-wrap gap-2">
              <button
                *ngFor="let keyword of jobDescription.resume_analysis?.missing_keywords"
                type="button"
                class="px-3 py-1 border border-gray-300 rounded-full text-sm hover:bg-gray-100"
                (click)="addKeyword(keyword)">
                {{ keyword }}
              </button>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Add New Projects</h2>
          <div class="grid md:grid-cols-2 gap-3">
            <input
              type="text"
              class="border border-gray-300 rounded px-3 py-2"
              placeholder="Project Name"
              [(ngModel)]="newProject.name">
            <input
              type="text"
              class="border border-gray-300 rounded px-3 py-2"
              placeholder="Duration (e.g., Jan 2024 - Mar 2024)"
              [(ngModel)]="newProject.duration">
          </div>
          <textarea
            class="w-full border border-gray-300 rounded px-3 py-2 mt-3"
            rows="3"
            placeholder="Project Description"
            [(ngModel)]="newProject.description"></textarea>
          <input
            type="text"
            class="w-full border border-gray-300 rounded px-3 py-2 mt-3"
            placeholder="Technologies (comma-separated)"
            [(ngModel)]="newProject.technologies">
          <button
            type="button"
            class="mt-3 px-4 py-2 bg-gray-900 text-white rounded hover:bg-black"
            (click)="addProject()">
            Add Project
          </button>

          <div class="mt-4 space-y-3" *ngIf="additionalProjects.length > 0">
            <div *ngFor="let project of additionalProjects; let i = index" class="border border-gray-200 rounded p-4">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h4 class="font-semibold text-gray-900">{{ project.name }}</h4>
                  <p class="text-sm text-gray-700 mt-1">{{ project.description }}</p>
                  <p class="text-sm text-gray-600 mt-1" *ngIf="project.technologies">
                    <strong>Tech:</strong> {{ project.technologies }}
                  </p>
                  <p class="text-sm text-gray-600" *ngIf="project.duration">
                    <strong>Duration:</strong> {{ project.duration }}
                  </p>
                </div>
                <button type="button" class="text-red-600 text-sm" (click)="removeProject(i)">Remove</button>
              </div>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Special Instructions (Optional)</h2>
          <textarea
            class="w-full border border-gray-300 rounded px-3 py-2"
            rows="4"
            placeholder="Any specific formatting or content requests..."
            [(ngModel)]="specialInstructions"></textarea>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6">
          <button
            type="button"
            [disabled]="!canSubmit()"
            class="px-6 py-3 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            (click)="submitRewrite()">
            {{ isSubmitting ? 'Starting rewrite...' : 'Generate Rewritten Resume' }}
          </button>
        </section>

        <section *ngIf="rewriteId" class="bg-white rounded-lg shadow-md p-6 space-y-4">
          <h3 class="text-lg font-semibold text-gray-900">Rewrite Status</h3>

          <div *ngIf="rewriteStatus === 'pending' || rewriteStatus === 'processing'" class="flex items-center gap-3 text-blue-700">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <p>Generating your resume... this usually takes 2-3 minutes.</p>
          </div>

          <div *ngIf="rewriteStatus === 'completed'" class="space-y-3">
            <p class="text-green-700 font-semibold">Resume generated successfully.</p>
            <div class="flex items-center gap-3">
              <button
                type="button"
                [disabled]="isDownloading || !hasPdfDownload"
                class="px-5 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                (click)="downloadPdf()">
                {{ isDownloading ? 'Preparing download...' : 'Download PDF' }}
              </button>
              <button
                type="button"
                [disabled]="isDownloading"
                class="px-5 py-2 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50"
                (click)="downloadLatex()">
                Download LaTeX
              </button>
            </div>
            <p *ngIf="!hasPdfDownload" class="text-sm text-gray-500">
              PDF compile was unavailable for this run. LaTeX download is still available.
            </p>
            <details>
              <summary class="cursor-pointer text-blue-700">Preview generated LaTeX</summary>
              <pre class="mt-3 p-3 bg-gray-100 rounded text-xs overflow-auto max-h-96">{{ latexCode }}</pre>
            </details>
          </div>

          <div *ngIf="rewriteStatus === 'failed'" class="text-red-700">
            <p>Generation failed.</p>
            <p class="text-sm mt-1">{{ rewriteError }}</p>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>
